//
//  ProtocolVulnerabilityScanner.swift
//  NMAPScanner - Protocol-Specific Vulnerability Detection
//
//  Created by Jordan Koch on 2025-11-27.
//

import Foundation

struct ProtocolVulnerability: Identifiable, Codable {
    let id = UUID()
    let host: String
    let port: Int
    let protocolName: String
    let vulnerability: String
    let severity: Severity
    let cveReferences: [String]
    let recommendation: String
    let timestamp: Date

    enum Severity: String, Codable {
        case critical, high, medium, low
    }
}

@MainActor
class ProtocolVulnerabilityScanner: ObservableObject {
    static let shared = ProtocolVulnerabilityScanner()

    @Published var vulnerabilities: [ProtocolVulnerability] = []
    @Published var isScanning = false

    private init() {}

    func scanProtocols(devices: [EnhancedDevice], banners: [ServiceBanner]) async {
        isScanning = true
        vulnerabilities.removeAll()

        for device in devices {
            for portInfo in device.openPorts {
                if let vuln = await checkProtocol(host: device.ipAddress, port: portInfo.port, banner: banners.first(where: { $0.host == device.ipAddress && $0.port == portInfo.port })) {
                    vulnerabilities.append(vuln)
                }
            }
        }

        isScanning = false
    }

    private func checkProtocol(host: String, port: Int, banner: ServiceBanner?) async -> ProtocolVulnerability? {
        switch port {
        case 445:  // SMB
            if banner?.banner.contains("SMBv1") == true {
                return ProtocolVulnerability(
                    host: host,
                    port: port,
                    protocolName: "SMB",
                    vulnerability: "SMBv1 Enabled - EternalBlue/WannaCry vulnerability",
                    severity: .critical,
                    cveReferences: ["CVE-2017-0144", "CVE-2017-0145"],
                    recommendation: "Disable SMBv1 immediately. Enable SMBv3 with encryption.",
                    timestamp: Date()
                )
            }
            return nil

        case 161:  // SNMP
            return ProtocolVulnerability(
                host: host,
                port: port,
                protocolName: "SNMP",
                vulnerability: "SNMP v1/v2c uses community strings (public/private)",
                severity: .high,
                cveReferences: [],
                recommendation: "Use SNMPv3 with authentication. Change default community strings.",
                timestamp: Date()
            )

        case 3389:  // RDP
            return ProtocolVulnerability(
                host: host,
                port: port,
                protocolName: "RDP",
                vulnerability: "RDP exposed - BlueKeep and other vulnerabilities possible",
                severity: .high,
                cveReferences: ["CVE-2019-0708"],
                recommendation: "Enable Network Level Authentication. Use VPN for RDP access.",
                timestamp: Date()
            )

        case 623:  // IPMI
            return ProtocolVulnerability(
                host: host,
                port: port,
                protocolName: "IPMI",
                vulnerability: "IPMI often has default credentials and known vulnerabilities",
                severity: .critical,
                cveReferences: ["CVE-2013-4786"],
                recommendation: "Change default IPMI credentials. Isolate on management network.",
                timestamp: Date()
            )

        case 123:  // NTP
            return ProtocolVulnerability(
                host: host,
                port: port,
                protocolName: "NTP",
                vulnerability: "NTP amplification attack vector if misconfigured",
                severity: .medium,
                cveReferences: [],
                recommendation: "Configure NTP with 'restrict' directives. Disable monlist.",
                timestamp: Date()
            )

        default:
            return nil
        }
    }
}
